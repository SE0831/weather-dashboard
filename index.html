<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WeatherNow - リアルタイム天気予報</title>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --glass-bg: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
            --text-primary: #ffffff;
            --text-secondary: rgba(255, 255, 255, 0.8);
            --shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            --border-radius: 20px;
        }

        body {
            font-family: 'Poppins', -apple-system, BlinkMacSystemFont, sans-serif;
            min-height: 100vh;
            color: var(--text-primary);
            overflow-x: hidden;
            position: relative;
        }

        /* Dynamic Backgrounds */
        .weather-bg {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: -1;
            transition: all 1s ease;
        }

        .weather-bg.clear {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .weather-bg.clouds {
            background: linear-gradient(135deg, #8e9eab 0%, #eef2f3 100%);
        }

        .weather-bg.rain {
            background: linear-gradient(135deg, #3a7bd5 0%, #3a6073 100%);
        }

        .weather-bg.snow {
            background: linear-gradient(135deg, #e6e9f0 0%, #eef1f5 100%);
        }

        .weather-bg.thunderstorm {
            background: linear-gradient(135deg, #232526 0%, #414345 100%);
        }

        .weather-bg.mist {
            background: linear-gradient(135deg, #606c88 0%, #3f4c6b 100%);
        }

        /* Weather animations */
        .weather-animation {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            z-index: 1;
        }

        /* Rain animation */
        .rain {
            position: absolute;
            width: 2px;
            height: 100px;
            background: linear-gradient(transparent, rgba(255, 255, 255, 0.3));
            animation: fall linear infinite;
        }

        @keyframes fall {
            to {
                transform: translateY(100vh);
            }
        }

        /* Snow animation */
        .snow {
            position: absolute;
            width: 10px;
            height: 10px;
            background: white;
            border-radius: 50%;
            animation: snowfall linear infinite;
        }

        @keyframes snowfall {
            to {
                transform: translateY(100vh) rotate(360deg);
            }
        }

        /* Cloud animation */
        .cloud {
            position: absolute;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 100px;
            opacity: 0.8;
            animation: float 20s infinite;
        }

        .cloud::before,
        .cloud::after {
            content: '';
            position: absolute;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 100px;
        }

        .cloud::before {
            width: 50px;
            height: 50px;
            top: -25px;
            left: 10px;
        }

        .cloud::after {
            width: 60px;
            height: 40px;
            top: -15px;
            right: 10px;
        }

        @keyframes float {
            0%, 100% { transform: translateX(-100px); }
            50% { transform: translateX(calc(100vw + 100px)); }
        }

        /* Container */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 2;
        }

        /* Header */
        .header {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius);
            padding: 20px 30px;
            margin-bottom: 30px;
            box-shadow: var(--shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .logo {
            font-size: 28px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo i {
            font-size: 32px;
        }

        .search-container {
            display: flex;
            gap: 12px;
            flex: 1;
            max-width: 500px;
        }

        .search-input {
            flex: 1;
            padding: 12px 20px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            color: white;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .search-input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .search-input:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.3);
        }

        .btn {
            padding: 12px 24px;
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            color: white;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .btn-icon {
            padding: 12px;
            width: 44px;
            height: 44px;
            justify-content: center;
        }

        /* Main Weather Card */
        .main-weather {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius);
            padding: 40px;
            margin-bottom: 30px;
            box-shadow: var(--shadow);
            text-align: center;
        }

        .city-name {
            font-size: 36px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .date-time {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 30px;
        }

        .temperature-display {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 30px;
            margin-bottom: 30px;
        }

        .weather-icon-main {
            font-size: 80px;
        }

        .temperature {
            font-size: 72px;
            font-weight: 300;
        }

        .temperature-unit {
            font-size: 36px;
            opacity: 0.8;
        }

        .weather-description {
            font-size: 24px;
            text-transform: capitalize;
            margin-bottom: 30px;
        }

        .weather-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
        }

        .detail-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .detail-icon {
            font-size: 24px;
            opacity: 0.8;
        }

        .detail-label {
            font-size: 12px;
            opacity: 0.6;
            text-transform: uppercase;
        }

        .detail-value {
            font-size: 18px;
            font-weight: 500;
        }

        /* Forecast Cards */
        .forecast-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .forecast-card {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--shadow);
            text-align: center;
            transition: all 0.3s ease;
        }

        .forecast-card:hover {
            transform: translateY(-5px);
            background: rgba(255, 255, 255, 0.15);
        }

        .forecast-day {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .forecast-icon {
            font-size: 40px;
            margin-bottom: 15px;
        }

        .forecast-temp {
            font-size: 24px;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .forecast-temp-range {
            font-size: 14px;
            opacity: 0.7;
        }

        /* Hourly Forecast */
        .hourly-forecast {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius);
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: var(--shadow);
        }

        .section-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .hourly-scroll {
            display: flex;
            gap: 15px;
            overflow-x: auto;
            padding-bottom: 10px;
        }

        .hourly-scroll::-webkit-scrollbar {
            height: 6px;
        }

        .hourly-scroll::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
        }

        .hourly-scroll::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 3px;
        }

        .hourly-item {
            min-width: 100px;
            text-align: center;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .hourly-time {
            font-size: 12px;
            opacity: 0.7;
            margin-bottom: 10px;
        }

        .hourly-icon {
            font-size: 24px;
            margin-bottom: 10px;
        }

        .hourly-temp {
            font-size: 16px;
            font-weight: 500;
        }

        /* Cities Grid */
        .cities-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .city-card {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .city-card:hover {
            transform: scale(1.02);
            background: rgba(255, 255, 255, 0.15);
        }

        .city-info {
            flex: 1;
        }

        .city-card-name {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .city-card-time {
            font-size: 12px;
            opacity: 0.7;
        }

        .city-weather {
            text-align: right;
        }

        .city-temp {
            font-size: 28px;
            font-weight: 500;
        }

        .city-condition {
            font-size: 12px;
            opacity: 0.7;
        }

        /* Settings Panel */
        .settings-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius);
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: var(--shadow);
        }

        .settings-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .settings-row:last-child {
            margin-bottom: 0;
        }

        .settings-label {
            font-size: 14px;
            font-weight: 500;
        }

        .toggle-switch {
            position: relative;
            width: 60px;
            height: 30px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .toggle-switch.active {
            background: rgba(102, 126, 234, 0.8);
        }

        .toggle-slider {
            position: absolute;
            top: 3px;
            left: 3px;
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .toggle-switch.active .toggle-slider {
            transform: translateX(30px);
        }

        /* Loading */
        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 1000;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 16px;
            opacity: 0.8;
        }

        /* Error Message */
        .error-message {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid rgba(239, 68, 68, 0.5);
            border-radius: 12px;
            padding: 15px;
            margin: 20px 0;
            text-align: center;
            display: none;
        }

        .error-message.show {
            display: block;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .header {
                flex-direction: column;
            }

            .search-container {
                width: 100%;
                max-width: none;
            }

            .main-weather {
                padding: 25px;
            }

            .city-name {
                font-size: 28px;
            }

            .temperature {
                font-size: 56px;
            }

            .weather-details {
                grid-template-columns: repeat(2, 1fr);
            }

            .forecast-container {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            }
        }

        /* Weather Icons Mapping */
        .weather-icon {
            display: inline-block;
        }

        .weather-icon.clear-day::before { content: '☀️'; }
        .weather-icon.clear-night::before { content: '🌙'; }
        .weather-icon.clouds::before { content: '☁️'; }
        .weather-icon.rain::before { content: '🌧️'; }
        .weather-icon.drizzle::before { content: '🌦️'; }
        .weather-icon.thunderstorm::before { content: '⛈️'; }
        .weather-icon.snow::before { content: '❄️'; }
        .weather-icon.mist::before { content: '🌫️'; }
    </style>
</head>
<body>
    <!-- Weather Background -->
    <div class="weather-bg clear" id="weatherBg"></div>
    <div class="weather-animation" id="weatherAnimation"></div>

    <!-- Loading Screen -->
    <div class="loading" id="loading">
        <div class="loading-spinner"></div>
        <div class="loading-text">天気情報を取得中...</div>
    </div>

    <!-- Main Container -->
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="logo">
                <i class="fas fa-cloud-sun"></i>
                WeatherNow
            </div>
            <div class="search-container">
                <input type="text" class="search-input" id="citySearch" placeholder="都市名を入力（例: Tokyo, New York）">
                <button class="btn" onclick="searchCity()">
                    <i class="fas fa-search"></i>
                    検索
                </button>
                <button class="btn btn-icon" onclick="getCurrentLocation()">
                    <i class="fas fa-location-dot"></i>
                </button>
            </div>
            <button class="btn btn-icon" onclick="toggleUnit()">
                <span id="unitToggle">°C</span>
            </button>
        </div>

        <!-- Error Message -->
        <div class="error-message" id="errorMessage"></div>

        <!-- Main Weather Display -->
        <div class="main-weather" id="mainWeather">
            <div class="city-name" id="cityName">読み込み中...</div>
            <div class="date-time" id="dateTime"></div>
            
            <div class="temperature-display">
                <div class="weather-icon weather-icon-main" id="mainWeatherIcon">
                    <span class="weather-icon clear-day"></span>
                </div>
                <div>
                    <span class="temperature" id="temperature">--</span>
                    <span class="temperature-unit">°C</span>
                </div>
            </div>
            
            <div class="weather-description" id="weatherDescription">--</div>
            
            <div class="weather-details">
                <div class="detail-item">
                    <i class="fas fa-temperature-half detail-icon"></i>
                    <span class="detail-label">体感温度</span>
                    <span class="detail-value" id="feelsLike">--°C</span>
                </div>
                <div class="detail-item">
                    <i class="fas fa-droplet detail-icon"></i>
                    <span class="detail-label">湿度</span>
                    <span class="detail-value" id="humidity">--%</span>
                </div>
                <div class="detail-item">
                    <i class="fas fa-wind detail-icon"></i>
                    <span class="detail-label">風速</span>
                    <span class="detail-value" id="windSpeed">-- m/s</span>
                </div>
                <div class="detail-item">
                    <i class="fas fa-gauge detail-icon"></i>
                    <span class="detail-label">気圧</span>
                    <span class="detail-value" id="pressure">-- hPa</span>
                </div>
                <div class="detail-item">
                    <i class="fas fa-eye detail-icon"></i>
                    <span class="detail-label">視程</span>
                    <span class="detail-value" id="visibility">-- km</span>
                </div>
                <div class="detail-item">
                    <i class="fas fa-sun detail-icon"></i>
                    <span class="detail-label">UV指数</span>
                    <span class="detail-value" id="uvIndex">--</span>
                </div>
            </div>
        </div>

        <!-- Hourly Forecast -->
        <div class="hourly-forecast">
            <h2 class="section-title">
                <i class="fas fa-clock"></i>
                時間別予報
            </h2>
            <div class="hourly-scroll" id="hourlyForecast">
                <!-- Hourly items will be added here -->
            </div>
        </div>

        <!-- 5 Day Forecast -->
        <div class="forecast-container" id="forecastContainer">
            <!-- Forecast cards will be added here -->
        </div>

        <!-- Favorite Cities -->
        <div class="cities-grid" id="favoriteCities">
            <!-- City cards will be added here -->
        </div>

        <!-- Settings -->
        <div class="settings-panel">
            <h2 class="section-title">
                <i class="fas fa-cog"></i>
                設定
            </h2>
            <div class="settings-row">
                <span class="settings-label">アニメーション効果</span>
                <div class="toggle-switch active" onclick="toggleAnimation(this)">
                    <div class="toggle-slider"></div>
                </div>
            </div>
            <div class="settings-row">
                <span class="settings-label">12時間表示</span>
                <div class="toggle-switch" onclick="toggle12Hour(this)">
                    <div class="toggle-slider"></div>
                </div>
            </div>
            <div class="settings-row">
                <span class="settings-label">風速単位 (km/h)</span>
                <div class="toggle-switch" onclick="toggleWindUnit(this)">
                    <div class="toggle-slider"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const API_KEY = 'YOUR_API_KEY_HERE';
        const API_BASE_URL = 'https://api.openweathermap.org/data/2.5';
        
        // State
        let currentCity = 'Tokyo';
        let currentUnit = 'metric'; // metric (°C) or imperial (°F)
        let favoriteCities = ['Tokyo', 'New York', 'London', 'Paris'];
        let animationsEnabled = true;
        let use12Hour = false;
        let windInKmh = false;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        // Initialize app
        async function initializeApp() {
            showLoading(true);
            
            // Load saved preferences
            loadPreferences();
            
            // Try to get current location
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    position => {
                        fetchWeatherByCoords(position.coords.latitude, position.coords.longitude);
                    },
                    error => {
                        // Fall back to default city
                        fetchWeatherByCity(currentCity);
                    }
                );
            } else {
                fetchWeatherByCity(currentCity);
            }
            
            // Setup event listeners
            document.getElementById('citySearch').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchCity();
                }
            });
            
            // Update time every minute
            setInterval(updateDateTime, 60000);
            updateDateTime();
        }

        // Fetch weather by city name
        async function fetchWeatherByCity(city) {
            try {
                showLoading(true);
                
                // Current weather
                const weatherResponse = await fetch(
                    `${API_BASE_URL}/weather?q=${city}&appid=${API_KEY}&units=${currentUnit}&lang=ja`
                );
                
                if (!weatherResponse.ok) {
                    throw new Error('都市が見つかりません');
                }
                
                const weatherData = await weatherResponse.json();
                
                // 5 day forecast
                const forecastResponse = await fetch(
                    `${API_BASE_URL}/forecast?q=${city}&appid=${API_KEY}&units=${currentUnit}&lang=ja`
                );
                
                const forecastData = await forecastResponse.json();
                
                // Process and display data
                const processedData = processWeatherData(weatherData);
                const processedHourly = processHourlyData(forecastData.list.slice(0, 8));
                const processedForecast = processForecastData(forecastData.list);
                
                displayWeather(processedData);
                displayHourlyForecast(processedHourly);
                displayForecast(processedForecast);
                updateFavoriteCities();
                
                currentCity = city;
                savePreferences();
                showLoading(false);
                
            } catch (error) {
                showError(error.message || '天気情報の取得に失敗しました');
                showLoading(false);
            }
        }

        // Fetch weather by coordinates
        async function fetchWeatherByCoords(lat, lon) {
            try {
                showLoading(true);
                
                // Current weather
                const weatherResponse = await fetch(
                    `${API_BASE_URL}/weather?lat=${lat}&lon=${lon}&appid=${API_KEY}&units=${currentUnit}&lang=ja`
                );
                
                if (!weatherResponse.ok) {
                    throw new Error('位置情報から天気を取得できません');
                }
                
                const weatherData = await weatherResponse.json();
                
                // 5 day forecast
                const forecastResponse = await fetch(
                    `${API_BASE_URL}/forecast?lat=${lat}&lon=${lon}&appid=${API_KEY}&units=${currentUnit}&lang=ja`
                );
                
                const forecastData = await forecastResponse.json();
                
                // Process and display data
                const processedData = processWeatherData(weatherData);
                const processedHourly = processHourlyData(forecastData.list.slice(0, 8));
                const processedForecast = processForecastData(forecastData.list);
                
                displayWeather(processedData);
                displayHourlyForecast(processedHourly);
                displayForecast(processedForecast);
                updateFavoriteCities();
                
                currentCity = weatherData.name;
                savePreferences();
                showLoading(false);
                
            } catch (error) {
                showError(error.message || '天気情報の取得に失敗しました');
                showLoading(false);
            }
        }

        // Process weather data from API
        function processWeatherData(data) {
            return {
                city: data.name,
                temp: data.main.temp,
                feelsLike: data.main.feels_like,
                description: data.weather[0].description,
                condition: getConditionType(data.weather[0].main),
                humidity: data.main.humidity,
                windSpeed: data.wind.speed,
                pressure: data.main.pressure,
                visibility: (data.visibility / 1000).toFixed(1),
                uvIndex: 5, // UV index requires different API endpoint
                sunrise: data.sys.sunrise,
                sunset: data.sys.sunset
            };
        }

        // Process hourly data
        function processHourlyData(hourlyList) {
            return hourlyList.map(item => ({
                time: new Date(item.dt * 1000).getHours(),
                temp: item.main.temp,
                condition: getConditionType(item.weather[0].main)
            }));
        }

        // Process forecast data
        function processForecastData(forecastList) {
            const dailyData = {};
            
            forecastList.forEach(item => {
                const date = new Date(item.dt * 1000);
                const day = date.toLocaleDateString('ja-JP', { weekday: 'long' });
                
                if (!dailyData[day]) {
                    dailyData[day] = {
                        day: day,
                        temps: [],
                        condition: getConditionType(item.weather[0].main)
                    };
                }
                
                dailyData[day].temps.push(item.main.temp);
            });
            
            return Object.values(dailyData).slice(0, 5).map(day => ({
                day: day.day,
                tempMin: Math.min(...day.temps),
                tempMax: Math.max(...day.temps),
                condition: day.condition
            }));
        }

        // Get condition type for styling
        function getConditionType(weatherMain) {
            const conditionMap = {
                'Clear': 'clear',
                'Clouds': 'clouds',
                'Rain': 'rain',
                'Drizzle': 'drizzle',
                'Thunderstorm': 'thunderstorm',
                'Snow': 'snow',
                'Mist': 'mist',
                'Fog': 'mist',
                'Haze': 'mist'
            };
            
            return conditionMap[weatherMain] || 'clear';
        }

        // Display weather data
        function displayWeather(data) {
            document.getElementById('cityName').textContent = data.city;
            document.getElementById('temperature').textContent = Math.round(data.temp);
            document.getElementById('weatherDescription').textContent = data.description;
            document.getElementById('feelsLike').textContent = `${Math.round(data.feelsLike)}°${currentUnit === 'metric' ? 'C' : 'F'}`;
            document.getElementById('humidity').textContent = `${data.humidity}%`;
            document.getElementById('windSpeed').textContent = formatWindSpeed(data.windSpeed);
            document.getElementById('pressure').textContent = `${data.pressure} hPa`;
            document.getElementById('visibility').textContent = `${data.visibility} km`;
            document.getElementById('uvIndex').textContent = data.uvIndex;
            
            // Update weather icon and background
            updateWeatherVisuals(data.condition);
            
            // Update main weather icon
            const iconElement = document.getElementById('mainWeatherIcon');
            iconElement.innerHTML = `<span class="weather-icon ${getWeatherIcon(data.condition)}"></span>`;
        }

        // Display hourly forecast
        function displayHourlyForecast(hourlyData) {
            const container = document.getElementById('hourlyForecast');
            container.innerHTML = '';
            
            hourlyData.forEach(hour => {
                const hourItem = document.createElement('div');
                hourItem.className = 'hourly-item';
                hourItem.innerHTML = `
                    <div class="hourly-time">${formatTime(hour.time)}</div>
                    <div class="hourly-icon">
                        <span class="weather-icon ${getWeatherIcon(hour.condition)}"></span>
                    </div>
                    <div class="hourly-temp">${Math.round(hour.temp)}°</div>
                `;
                container.appendChild(hourItem);
            });
        }

        // Display 5-day forecast
        function displayForecast(forecastData) {
            const container = document.getElementById('forecastContainer');
            container.innerHTML = '';
            
            forecastData.forEach(day => {
                const forecastCard = document.createElement('div');
                forecastCard.className = 'forecast-card';
                forecastCard.innerHTML = `
                    <div class="forecast-day">${day.day}</div>
                    <div class="forecast-icon">
                        <span class="weather-icon ${getWeatherIcon(day.condition)}"></span>
                    </div>
                    <div class="forecast-temp">${Math.round(day.tempMax)}°</div>
                    <div class="forecast-temp-range">
                        ${Math.round(day.tempMin)}° / ${Math.round(day.tempMax)}°
                    </div>
                `;
                container.appendChild(forecastCard);
            });
        }

        // Update favorite cities
        async function updateFavoriteCities() {
            const container = document.getElementById('favoriteCities');
            container.innerHTML = '<h2 class="section-title"><i class="fas fa-star"></i> お気に入りの都市</h2>';
            
            for (const city of favoriteCities) {
                try {
                    const response = await fetch(
                        `${API_BASE_URL}/weather?q=${city}&appid=${API_KEY}&units=${currentUnit}&lang=ja`
                    );
                    
                    if (!response.ok) continue;
                    
                    const data = await response.json();
                    
                    const cityCard = document.createElement('div');
                    cityCard.className = 'city-card';
                    cityCard.onclick = () => fetchWeatherByCity(city);
                    cityCard.innerHTML = `
                        <div class="city-info">
                            <div class="city-card-name">${data.name}</div>
                            <div class="city-card-time">${new Date().toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' })}</div>
                        </div>
                        <div class="city-weather">
                            <div class="city-temp">${Math.round(data.main.temp)}°</div>
                            <div class="city-condition">${data.weather[0].description}</div>
                        </div>
                    `;
                    container.appendChild(cityCard);
                } catch (error) {
                    console.error(`Failed to fetch weather for ${city}:`, error);
                }
            }
        }

        // Update weather visuals
        function updateWeatherVisuals(condition) {
            const bg = document.getElementById('weatherBg');
            const animation = document.getElementById('weatherAnimation');
            
            // Remove all weather classes
            bg.className = 'weather-bg';
            animation.innerHTML = '';
            
            // Add appropriate class and animations
            switch(condition) {
                case 'clear':
                    bg.classList.add('clear');
                    break;
                case 'clouds':
                    bg.classList.add('clouds');
                    if (animationsEnabled) createClouds();
                    break;
                case 'rain':
                case 'drizzle':
                    bg.classList.add('rain');
                    if (animationsEnabled) createRain();
                    break;
                case 'snow':
                    bg.classList.add('snow');
                    if (animationsEnabled) createSnow();
                    break;
                case 'thunderstorm':
                    bg.classList.add('thunderstorm');
                    if (animationsEnabled) createRain();
                    break;
                case 'mist':
                case 'fog':
                    bg.classList.add('mist');
                    break;
            }
        }

        // Create rain animation
        function createRain() {
            const animation = document.getElementById('weatherAnimation');
            for (let i = 0; i < 50; i++) {
                const rain = document.createElement('div');
                rain.className = 'rain';
                rain.style.left = Math.random() * 100 + '%';
                rain.style.animationDuration = Math.random() * 1 + 0.5 + 's';
                rain.style.animationDelay = Math.random() * 2 + 's';
                animation.appendChild(rain);
            }
        }

        // Create snow animation
        function createSnow() {
            const animation = document.getElementById('weatherAnimation');
            for (let i = 0; i < 30; i++) {
                const snow = document.createElement('div');
                snow.className = 'snow';
                snow.style.left = Math.random() * 100 + '%';
                snow.style.animationDuration = Math.random() * 5 + 5 + 's';
                snow.style.animationDelay = Math.random() * 5 + 's';
                snow.style.opacity = Math.random() * 0.6 + 0.4;
                animation.appendChild(snow);
            }
        }

        // Create clouds animation
        function createClouds() {
            const animation = document.getElementById('weatherAnimation');
            for (let i = 0; i < 3; i++) {
                const cloud = document.createElement('div');
                cloud.className = 'cloud';
                cloud.style.width = Math.random() * 100 + 100 + 'px';
                cloud.style.height = Math.random() * 40 + 40 + 'px';
                cloud.style.top = Math.random() * 40 + '%';
                cloud.style.animationDuration = Math.random() * 20 + 20 + 's';
                cloud.style.animationDelay = Math.random() * 10 + 's';
                animation.appendChild(cloud);
            }
        }

        // Search city
        function searchCity() {
            const input = document.getElementById('citySearch');
            const city = input.value.trim();
            
            if (city) {
                currentCity = city;
                fetchWeatherByCity(city);
                input.value = '';
            }
        }

        // Get current location
        function getCurrentLocation() {
            if (navigator.geolocation) {
                showLoading(true);
                navigator.geolocation.getCurrentPosition(
                    position => {
                        fetchWeatherByCoords(position.coords.latitude, position.coords.longitude);
                    },
                    error => {
                        showError('位置情報の取得に失敗しました');
                        showLoading(false);
                    }
                );
            } else {
                showError('お使いのブラウザは位置情報に対応していません');
            }
        }

        // Toggle temperature unit
        function toggleUnit() {
            currentUnit = currentUnit === 'metric' ? 'imperial' : 'metric';
            document.getElementById('unitToggle').textContent = currentUnit === 'metric' ? '°C' : '°F';
            fetchWeatherByCity(currentCity);
        }

        // Toggle animation
        function toggleAnimation(element) {
            element.classList.toggle('active');
            animationsEnabled = element.classList.contains('active');
            
            if (!animationsEnabled) {
                document.getElementById('weatherAnimation').innerHTML = '';
            } else {
                fetchWeatherByCity(currentCity);
            }
            savePreferences();
        }

        // Toggle 12-hour format
        function toggle12Hour(element) {
            element.classList.toggle('active');
            use12Hour = element.classList.contains('active');
            updateDateTime();
            savePreferences();
        }

        // Toggle wind unit
        function toggleWindUnit(element) {
            element.classList.toggle('active');
            windInKmh = element.classList.contains('active');
            fetchWeatherByCity(currentCity);
            savePreferences();
        }

        // Format wind speed
        function formatWindSpeed(speed) {
            if (windInKmh) {
                return `${Math.round(speed * 3.6)} km/h`;
            }
            return `${speed.toFixed(1)} m/s`;
        }

        // Format time
        function formatTime(hour) {
            if (use12Hour) {
                const h = hour % 12 || 12;
                const ampm = hour < 12 ? 'AM' : 'PM';
                return `${h}:00 ${ampm}`;
            }
            return `${hour}:00`;
        }

        // Update date and time
        function updateDateTime() {
            const now = new Date();
            const options = {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: use12Hour ? 'numeric' : '2-digit',
                minute: '2-digit',
                hour12: use12Hour
            };
            
            const dateTimeStr = now.toLocaleDateString('ja-JP', options);
            document.getElementById('dateTime').textContent = dateTimeStr;
        }

        // Get weather icon class
        function getWeatherIcon(condition) {
            const iconMap = {
                'clear': 'clear-day',
                'clouds': 'clouds',
                'rain': 'rain',
                'drizzle': 'drizzle',
                'thunderstorm': 'thunderstorm',
                'snow': 'snow',
                'mist': 'mist',
                'fog': 'mist'
            };
            return iconMap[condition] || 'clear-day';
        }

        // Show/hide loading
        function showLoading(show) {
            const loading = document.getElementById('loading');
            loading.style.display = show ? 'block' : 'none';
        }

        // Show error message
        function showError(message) {
            const errorEl = document.getElementById('errorMessage');
            errorEl.textContent = message;
            errorEl.classList.add('show');
            
            setTimeout(() => {
                errorEl.classList.remove('show');
            }, 5000);
        }

        // Load preferences
        function loadPreferences() {
            const saved = localStorage.getItem('weatherPreferences');
            if (saved) {
                const prefs = JSON.parse(saved);
                currentUnit = prefs.unit || 'metric';
                animationsEnabled = prefs.animations !== false;
                use12Hour = prefs.use12Hour || false;
                windInKmh = prefs.windInKmh || false;
                favoriteCities = prefs.favoriteCities || favoriteCities;
                currentCity = prefs.currentCity || 'Tokyo';
            }
        }

        // Save preferences
        function savePreferences() {
            const prefs = {
                unit: currentUnit,
                animations: animationsEnabled,
                use12Hour: use12Hour,
                windInKmh: windInKmh,
                favoriteCities: favoriteCities,
                currentCity: currentCity
            };
            localStorage.setItem('weatherPreferences', JSON.stringify(prefs));
        }

        // Get weather description
        function getWeatherDescription(condition) {
            const descriptions = {
                'clear': '晴れ',
                'clouds': '曇り',
                'rain': '雨',
                'drizzle': '小雨',
                'thunderstorm': '雷雨',
                'snow': '雪',
                'mist': '霧'
            };
            return descriptions[condition] || '晴れ';
        }
    </script>
</body>
</html>